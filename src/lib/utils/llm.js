import { POLLINATIONS } from "$env/static/private";

const configSQL = `Your only task is to convert the user's question into a single SQL query (PostgreSQL NEVER REPLY IN MARKDOWN AND ALWAYS PUT QUOTES IN COLUMNS AND TABLES NAMES. Use the database schema provided in the context. NEVER return text that is not pure SQL code. Use only the tables 'bovinos', 'FichaLactacao', 'OcorrenciaEvento', and 'AssociacaoBovinos' and use only its columns. If it is not possible to generate a query, return the string: null. When the user talks about "VacaXXXXXXX" or "TouroXXXXXXX" he's talking about the bovinos, nome column. table public."FichaLactacao" (dataencerramento date null, formacoleta text null, idademesesparto bigint null, "idAnimal" bigint null, ideventoparto bigint null, ideventoseca bigint null, numeroordenhas bigint null, qtdediaslactacao double precision null, qtdegordura305 double precision null, qtdeleite305 double precision null, qtdeproteinas305 double precision null, codigo character varying null, id bigint generated by default as identity not null); table public.bovinos (codigo character varying null default ''::character varying, "dataNascimento" timestamp without time zone null, nome character varying null, "paisOrigem" character varying null, raça bigint null, "idAnimal" bigint generated by default as identity not null, constraint bovinos_pkey primary key ("idAnimal")); create table public."OcorrenciaEvento" (id bigint generated by default as identity not null, "idAnimal" bigint not null, "dataOcorrencia" date null, facilidade_parto text null, nro_crias bigint null, qtde_litros bigint null, sexo_crias text null, tipo_evento bigint null, constraint OcorrenciaEvento_1_pkey primary key (id)); table public."AssociacaoBovinos" (ascendente_id bigint generated by default as identity not null, bovino_id bigint not null, situacao bigint null, tipo bigint null, id bigint generated by default as identity not null, constraint AssociacaoBovinos_pkey primary key (id)). AssociacaoBovinos.tipo(int): 2 means mãe, 1 means pai; OcorrenciaEvento.tipo_evento (int): 7 means abertura_lactacao, 3 means cobertura, 2 means obito, 4 means ordenha, 1 means parto, 5 means pesagem, 6 means seca. \nWhenever a question is related to identifying the bull with the highest average milk production of daughters for a specific calving order, adapt this query to calculate the average for the requested order (first, second, third, etc.). Use the following SQL model as the base: WITH p AS (SELECT \"idAnimal\" i, MIN(ideventoparto) e FROM public.\"FichaLactacao\" WHERE qtdeleite305 IS NOT NULL GROUP BY \"idAnimal\"),\nl AS (SELECT f.\"idAnimal\" i, f.qtdeleite305 q FROM public.\"FichaLactacao\" f JOIN p ON f.\"idAnimal\"=p.i AND f.ideventoparto=p.e),\nfp AS (SELECT bovino_id f, ascendente_id t FROM public.\"AssociacaoBovinos\"),\nm AS (SELECT b.\"nome\" n, AVG(l.q) a FROM l JOIN fp ON l.i=fp.f JOIN public.bovinos b ON b.\"idAnimal\"=fp.t GROUP BY b.\"nome\")\nSELECT n, a FROM m ORDER BY a DESC LIMIT 1; \nWhenever a question is related to genealogy, use the following SQL model as the base: WITH RECURSIVE g AS ( SELECT 1 n,b."idAnimal" i,b."nome" d,a.ascendente_id a,p."nome" p FROM public.bovinos b JOIN public."AssociacaoBovinos" a ON b."idAnimal"=a.bovino_id JOIN public.bovinos p ON p."idAnimal"=a.ascendente_id WHERE b."idAnimal"=:id_animal_alvo UNION ALL SELECT n+1,a,p,a2.ascendente_id,p2."nome" FROM g JOIN public."AssociacaoBovinos" a2 ON a=a2.bovino_id JOIN public.bovinos p2 ON p2."idAnimal"=a2.ascendente_id WHERE n<3 ) SELECT n geracao,d descendente,p ascendente FROM g ORDER BY n,d;`;
const configAnswer = `Your role is to transform the data resulting from an SQL query in JSON format into a coherent and user-friendly response. Use the original question and the data to generate the answer. If the data is empty, politely inform the user. If you run out in any problem, answer being honest and direct. DON'T TALK ABOUT TECHNICAL STUFF, LIKE SQL OR DATABASES. Don't offer help to fix problems or suggestions like that. tipo_evento (int): 7 means abertura_lactacao, 3 means cobertura, 2 means obito, 4 means ordenha, 1 means parto, 5 means pesagem, 6 means seca`;

// POLLINATIONS
export async function generateSQLQuery2(prompt) {
  const url = new URL(
    `https://text.pollinations.ai/${encodeURIComponent(prompt)}`
  );

  url.searchParams.set("model", "openai");
  url.searchParams.set("system", configSQL);
  url.searchParams.set("temperature", "1");

  const response = await fetch(url, {
    headers: {
      "Authorization": `Bearer ${POLLINATIONS}`, // substitua YOUR_API_KEY pelo token real
    },
  });

  const result = await response.text();
  return result;
}

// N8N
export async function generateSQLQuery(prompt) {
  const body = {
    prompt,
    system: configSQL,
  };

  const response = await fetch("https://lucas485.app.n8n.cloud/webhook/ai", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(body),
  });

  if (response.status == 200) {
    return await response.text();
  } else {
    console.error(response.text());
    throw "Error generating SQL: " + response.text();
  }
}

// N8N
export async function generateFinalAnswer(prompt, data) {
  const body = {
    prompt: prompt + " SQL query result: " + JSON.stringify(data),
    system: configAnswer,
  };

  const response = await fetch("https://lucas485.app.n8n.cloud/webhook/ai", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(body),
  });

  if (response.status == 200) {
    return await response.text();
  } else {
    console.error(response.text());
    throw "Error generating final answer: " + response.text();
  }
}

/*
export async function generateFinalAnswer(prompt, data) {
  const url = new URL(
    `https://text.pollinations.ai/${encodeURIComponent(
      prompt + " SQL query result: " + JSON.stringify(data)
    )}`
  );
  url.searchParams.set("model", "openai");
  url.searchParams.set("system", configAnswer);
  url.searchParams.set("temperature", "1");

  // console.log(url.href);
  const response = await fetch(url);
  const result = await response.text();
  return result;
}
*/
